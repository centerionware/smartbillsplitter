# Stage 1: Build the TypeScript backend
FROM node:20-alpine AS builder
WORKDIR /app
COPY package*.json ./
# Install production dependencies and dev dependencies needed for build
RUN npm ci
COPY . .
# Run the backend-specific build script
RUN npm run build:backend

# Stage 2: Create the minimal production image
FROM node:20-alpine
WORKDIR /app
# Copy only production dependencies from the builder
COPY --from=builder /app/node_modules ./node_modules
COPY --from=builder /app/package.json ./package.json
# Copy the compiled server code
COPY --from=builder /app/dist-server ./dist-server

# Expose the port the server listens on
EXPOSE 3000

# Start the server
CMD ["node", "dist-server/server.js"]
